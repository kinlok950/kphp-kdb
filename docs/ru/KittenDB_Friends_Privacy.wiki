''Приватность'' -- это некоторый набор правил, определяющих множество пользователей, которым разрешен доступ к тому или иному объекту. В рамках описываемой системы для обращения к приватности надо знать id ее владельца (пользователя, которому принадлежит нужный объект) и некоторый уникальный [[#Ключ приватности|ключ приватности]]. Значение приватности есть набор правил, включающий или исключающих из рассмотрения некоторые папки друзей владельца приватности либо отдельных пользователей. Такой набор правил обычно передается в виде [[#Описание приватности|строки специального вида]].

== Ключ приватности ==
''Ключ приватности'' --- это строка, которая вместе с id пользователя-владельца однозначно идентифицирует нужную приватность (тип объекта, его id и проверяемое действие над ним).
<br>
Состоит из последовательности латинских букв (''основы''), за которой следует ''окончание'' --- либо десятичная запись неотрицательного 32-битного целого числа, либо знак подчеркивания и еще одна строка. Примеры:
<pre>
priv_mphone
priv_profile_view
album17239
note666666
notecomm6666666
</pre>
Деление на ''основу'' и ''окончание'' важно для проверки всех приватностей по шаблону вида <code>''stem''*</code>: например, при проверки приватности запрос к 'priv*' вернет 'priv_mphone' и 'priv_profile_view', но не 'private_data'; 'note*' выберет 'note666666', но не 'notecomm6666666'.

== Описание приватности ==

''Описание приватности'' --- это строка, представляющая собой запись набора правил, задающих множество пользователей, соответствующих данной приватности.

Каждое правило имеет один из четырех допустимых форматов
<pre>
+''user_id''
-''user_id''
<nowiki>*</nowiki>''cat_id''
/''cat_id''
</pre>
Первые два правила разрешают или запрещают доступ пользователю ''user_id'', где ''user_id'' должно быть десятичной записью положительного 32-битного числа. Вторые два правила разрешают или запрещают доступ сразу некоторой категории пользователей.
<br>
Если ''cat_id'' есть целое число от 1 до 30, доступ разрешается или запрещается соответствующей папке друзей владельца приватности. В противном случае ''cat_id'' должно принимать одно из специальных односимвольных значений:

{|
|-
| <tt>'''A'''</tt> || все пользователи
|-
| <tt>'''G'''</tt> || все друзья и друзья друзей
|-
| <tt>'''0'''</tt> || все друзья
|}

Итоговое значение описания приватности есть строка, полученная конкатенацией всех правил, входящих в приватность, в порядке их проверки. Правила проверяются так:
* Если пользователь, запросивший проверку, есть владелец приватности, проверка успешна.
* В противном случае проверяется, подходит ли запросивший пользователь под очередное правило.
** Если это так, то результат проверки приватности определяется "знаком" первого подошедшего правила, и дальнейшие правила не проверяются.
** Иначе проверяется следующее правило, и т.д.
* Если просмотрены все правила и ни одно не подошло, проверка приватности считается неуспешной.

Например, <code>*G</code> разрешает доступ всем друзьям друзей, <code>-1-6*0</code> разрешает доступ всем друзьям, кроме пользователей 1 и 6, <code>*A</code> разрешает доступ всем, <code>+1/2*0</code> разрешает доступ всем друзьям, если только они не принадлежат второй папке друзей; однако при этом пользователю 1 доступ все-таки разрешается, даже если он и попал во вторую папку друзей.

== Канонический вид ==
Система принимает любые приватности указанного формата, однако сохраняет и возвращает их в ''минимальном каноническом виде''.
<br>
Будем говорить, что две приватности (т.е. два описания приватности) ''эквивалентны'', если им соответствуют одинаковые множества пользователей для любого набора папок друзей (иначе говоря, приватности <code>/3*2</code> и <code>/3</code> не считаются эквивалентными, даже если на момент их создания папка друзей 2 содержится в папке друзей 3, поскольку это может измениться в будущем).

Приватность ''минимальна'', если любая эквивалентная ей приватность содержит не меньшее количество правил. Приватность находится в ''каноническом виде'', если:
* В любой серии подряд идущих разрешающих правил (типа '+' и '*') сначала идут все групповые правила ('*'), а затем все индивидуальные ('+').
* Подряд идущие групповые правила <code>*''cat''</code> расположены в порядке возрастания номера категории ''cat'', и аналогично для подряд идущих индивидуальных правил <code>+''user_id''</code>.
* Аналогичные утверждения верны и для любой серии подряд идущих запрещающих правил: в ней сначала должны идти все групповые правила ('/'), а затем все индивидуальные ('-'), упорядоченные по значению параметра.

Наконец, ''минимальная каноническая форма'' (или ''вид'') приватности есть приватность, эквивалентная исходной и при этом являющаяся минимальной и канонической. Можно доказать, что такая форма единственна.

Например:
{|
|-
! Исходная приватность !! Минимальная каноническая форма
|-
| <code>-3+2</code> || <code>+2</code>
|-
| <code>-3/0+2</code> || <code>/0+2</code>
|-
| <code>-3/0*2</code> || ''(пустая строка)''
|-
| <code>-1+2*3/4*0/G*A</code> || <code>-1*3+2/4*0/G*A</code>
|}
