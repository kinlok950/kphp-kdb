== Общие друзья через friends-engine ==

Общие друзья через friends-engine реализуются через специальный режим запуска [[KittenDB_Friends.wiki|friends-engine]] (со специальным ключом) и через отдельное расширение mc-proxy-search (или rpc-proxy, если используется rpc-протокол). 

При запуске с этим ключом (-A) friends-engine работает только в режиме репликации (-r) и умеет выполнять только два содержательных типа запросов на получение данных (конечно, помимо get stats и т.п.), приведенных далее.

=== Инициализация ===
Для доступа из PHP необходимо сделать
<blockquote><code>$MC_Common_Friends = new Memcache ($ip, $port, ...);</code></blockquote>
и далее запускать функции <code>$MC_Common_Friends->get(...)</code> и <code>$MC_Common_Friends->set(...)</code>, как объяснено ниже.

=== Задержка при учете обновлений ===
Поскольку данный кластер получает обновления только через репликацию, только что произведенные изменения в основном кластере friends (добавление/удаление друга) могут быть учтены в common-friends с задержкой до одной секунды (типичное время - несколько сотых секунды). Это следует учитывать при обращении из PHP в рамках выполнения одного PHP-скрипта.

=== Получение количества общих друзей для указанного пользователя и списка пользователей ===
<code>get("common_friends_num{$user_id}:{$user1_id},...,{$userN_id}")</code>
<br>
или
<br>
<code>set("userlist{$tag}", 0, 0, "{$user1_id},...,{$userN_id}");</code>
<br>
<code>get("common_friends_num{$user_id}:{$tag}")</code>
<br>
Во второй форме $tag -- отрицательное число от -1e9 до -1. Параметры $user_id и $userK_id --- положительные целые числа. Допускается передача не более 10000 user_id за один раз (т.е. N &lt;= 10000).
<br>
Результатом является последовательность из N+1 неотрицательного целых чисел, представленных в виде их десятичных записей, разделенных запятыми. Допускается также предварение ключа common_friends знаком процента, в этом случае результат возвращается в двоичном виде (4N+4 байтов). Первое число - это количество кусков friends, по которым был вычислен данный ответ, что может использоваться для проверки полноты ответа (в настоящее время это число должно равняться 200, если все хорошо). K-ое число из остальной части возвращенной последовательности - это количество общих друзей $user_id и $userK_id, принадлежащих данному куску friends.

=== Получение списка общих друзей двух пользователей ===
<code>get("common_friends{$user1_id},{$user2_id}")</code>
<br>
Возвращает список общих друзей двух пользователей в виде последовательности целых чисел: первое число - количество общих друзей в списке, далее следуют их id в порядке возрастания. Допускается также применение модификатора % перед названием ключа, в этом случае данные возвращаются в двоичном виде.

При этом поддерживаются multiget'ы (получение нескольких ключей одним запросом get). Более того, если сохранить список пользователей через set ("userlist{$tag}"), то на него можно ссылаться несколько раз внутри следующего multiget'а. Таким образом, можно вычислить матрицу количеств общих друзей для любого набора пользователей, расположенных по строкам и по столбцам матрицы.
