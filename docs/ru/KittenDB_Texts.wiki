''KittenDB Texts'' --- система для хранения больших объемов текстов, например, личных сообщений, стен и т.п.

== Общая структура ==

=== Сообщения и ящики ===
Для краткости мы будем называть каждый отдельный текст ''сообщением'', которые объединяются в ''ящики'', или ''списки''. Каждое сообщение находится ровно в одном списке, который характеризуется значением поля uid (или user_id) этого сообщения. Например, личные сообщения группируются по пользователю-владельцу сообщения. Практически все функции доступа работают ровно с одним списком сообщений, для указания на который передается соответствующий uid. Можно считать, что каждый список сообщений хранится независимо от всех остальных.

=== Атрибуты сообщения ===

Помимо идентификатора списка ("владельца") uid, сообщение обладает следующими атрибутами:

{|
|-
| <code>uid</code> || Идентификатор ящика (списка), содержащего сообщение. Ненулевое 32-битное целое.
|-
| <code>local_id</code> || ''Локальный идентификатор'' сообщения внутри ящика. Первое сообщение, добавленное в ящик, получает local_id=1, следующее - 2 и т.д. При удалении сообщения local_id следующих сообщений не сдвигается, и вообще он никогда не изменяется.
|-
| <code>flags</code> || 8-битное (а для некоторых целей - 16-битное) поле ''флагов'', см. ниже. Используется, например, для различения входящих и исходящих сообщений.
|-
| <code>date</code> || ''Дата создания'' сообщения (unixtime).
|-
| <code>global_id</code> || ''Глобальный идентификатор'' сообщения среди всех ящиков, хранимых в одном text-engine. Назначается по тому же принципу, что и local_id, но в рамках всего text-engine. Нужен в основном для различных административных и статистических функций.
|-
|  <code>legacy_id</code> || Старый идентификатор сообщения (32-битное целое), может использоваться для выборки сообщения в ящике. Нужен в тех случаях, когда надо сохранить возможность доступа по старым идентификаторам, отличным от local_id.
|-
| <code>peer_id</code> || Идентификатор корреспондента - например, другого пользователя - отправителя входящего или получателя исходящего сообщения.
|-
| <code>peer_msg_id</code> || Идентификатор связанного сообщения в ящике корреспондента (например, его исходящего сообщения, соответствующего нашему входящему). Если отрицателен, соответствует legacy_id, иначе local_id.
|-
| <code>text</code> || Текст сообщения произвольной длины. Если необходимо указывать тему и само сообщение, то они разделяются табуляцией; при этом в теме табуляции не допускаются.
|}

=== Дополнительные поля ===

Помимо этого, с каждой записью в text-engine может быть связано до 8 дополнительных 32-битных полей (<tt>extra0</tt>..<tt>extra7</tt>), а также до 4 дополнительных 64-битных полей (<tt>Extra8</tt>..<tt>Extra11</tt>) для хранения 64-битных значений. То, какие именно из двенадцати возможных дополнительных полей могут в принципе использоваться в данном экземпляре text-engine, указывается при создании соответствующего бинлога. По ходу работы добавлять или удалять поля можно только отложенно (запросить подобное изменение и ждать до суток, когда оно реально произойдет).

=== Кладжи ===

С каждым сообщением могут быть связаны т.н. '''кладжи''' (cludges) - дополнительные данные, хранящиеся перед текстом сообщения. Каждый кладж имеет вид <code>[\x1|\x2] <идентификатор - название кладжа> \x20 <строка символов без табуляций - значение кладжа> \t</code>. Символ \x2 используется в том случае, если значение кладжа должно учитываться в поиске.

Для сохранения кладжа достаточно дописать один или несколько кладжей перед текстом нового сообщения. При этом при получении сообщения по умолчанию кладжи не возвращаются. Если же они явно запрошены, они возвращаются перед текстом сообщения ровно в том же виде, как при сохранении.

=== Флаги ===

Одним из самых важных атрибутов сообщения являются ''флаги'' - 8-битное (иногда - 16-битное) поле. Его точный смысл зависит от конкретного применения text-engine. Их примерный смысл таков:

{|
|-
| +1 ||  UNREAD || сообщение непрочитано
|-
| +2 || OUTBOX || исходящее сообщение
|-
| +4 || REPLIED || на сообщение был создан ответ
|-
| +8 || IMPORTANT || помеченное сообщение
|-
| +16 || CHAT || сообщение отправлено через чат
|-
| +32 || FRIENDS || сообщение отправлено другом
|-
| +64 || SPAM || сообщение в папке "Спам"
|-
| +128 || DELЕTЕD || сообщение удалено (в корзине)
|-
| +256 || FIXED || сообщение проверено пользователем на спам
|-
| +512 || MEDIA || сообщение содержит медиаконтент
|-
| +1024 || ATTACH || к сообщению прикреплен файл
|-
| +2048 || EMAIL || сообщение получено или отправлено по электропочте
|-
| +4096 || NOCHAT || сообщение не должно выводиться в чате
|-
| +8192 || MULTICHAT || сообщение отправленное в мультичат (несколько собеседников, peer_id > 2e9)
|}

=== Подсписки ===

В зависимости от своих флагов сообщения одного ящика группируются в ''подсписки''. Сообщение может состоять в нескольких подсписках, а может не состоять ни в одном. Подсписок обычно задается парой целых чисел <code>$and_mask:$xor_mask</code>, разделенных двоеточием. Первое число - <code>$and_mask</code> - есть сумма проверяемых флагов; второе - <code>$xor_mask</code> - есть сумма правильных значений для этих флагов. Например, <code>130:2</code> означает "те сообщения, у которых установлен флаг OUTBOX и не установлен DELЕTЕD", а <code>131:1</code> означает "сообщения, у которых установлен UNREAD и сброшен OUTBOX и DELЕTЕD", т.е. неудаленные непрочитанные входящие сообщения.

Важно отметить, что набор типов подсписков, которых можно получать для каждого ящика, фиксирован и предопределен для каждого экземпляра text-engine. При попытке работать с подсписком, не входящим в этот предопределенный набор, возвращается ошибка <code>NOT_SUPPORTED</code>.

== Список доступных функций ==
См. [[KittenDB_Texts_Functions.wiki|KittenDB Texts Functions]].

== Список дополнительных функций (поиск и работа с историей) ==
См. [[KittenDB_Texts_Extra.wiki|KittenDB Texts Extra]].

== http-интерфейс для чата ==
См. [[KittenDB_Texts_HTTP.wiki|KittenDB Texts HTTP]].

=== Поддержка списка друзей онлайн ===
См. [[KittenDB_Texts_Online.wiki|KittenDB Texts Online]]
